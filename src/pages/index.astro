---
import Layout from '@layouts/Layout.astro';
import { Navbar } from '@layouts/header';
import { Hero } from '@features/hero';
import { BenefitsEnhanced } from '@features/benefits';
import { Pricing } from '@features/pricing';
import { Countdown } from '@features/countdown';
import { Testimonials } from '@features/testimonials';
import { TrustBar } from '@features/trust-bar';
import { FAQ } from '@features/faq';
import { FooterContact } from '@layouts/footer';
import { ScrollReveal } from '@common';

const metadata = {
  title: 'Tử Vi Trúc Nghi – Luận giải Tử Vi/Bát Tự chuyên nghiệp',
  description:
    'Luận giải Tử Vi chuyên nghiệp - Biết vận hạn, nắm cơ hội, tránh rủi ro. Nhận PDF chi tiết trong 24 giờ. Tư vấn tài lộc, quan lộc, tình cảm, sức khỏe.',
  canonical: 'https://trucnghi.vercel.app',
  image: {
    src: '~/assets/images/trucnghi-og.png',
    alt: 'Tử Vi Trúc Nghi - Luận giải tử vi chuyên nghiệp',
  },
};

// JSON-LD structured data
const jsonLD = {
  '@context': 'https://schema.org',
  '@graph': [
    {
      '@type': 'Organization',
      '@id': 'https://trucnghi.vercel.app/#organization',
      name: 'Tử Vi Trúc Nghi',
      url: 'https://trucnghi.vercel.app',
      logo: {
        '@type': 'ImageObject',
        url: 'https://trucnghi.vercel.app/logo.png',
      },
      contactPoint: {
        '@type': 'ContactPoint',
        telephone: '+84-901-234-567',
        contactType: 'customer service',
        availableLanguage: 'Vietnamese',
      },
      sameAs: ['https://facebook.com/trucnghi', 'https://t.me/trucnghi'],
    },
    {
      '@type': 'Service',
      '@id': 'https://trucnghi.vercel.app/#service',
      name: 'Luận giải Tử Vi chuyên nghiệp',
      description: 'Dịch vụ luận giải tử vi, bát tự chuyên nghiệp với độ chính xác cao',
      provider: {
        '@id': 'https://trucnghi.vercel.app/#organization',
      },
      areaServed: {
        '@type': 'Country',
        name: 'Vietnam',
      },
      hasOfferCatalog: {
        '@type': 'OfferCatalog',
        name: 'Gói luận giải tử vi',
        itemListElement: [
          {
            '@type': 'Offer',
            itemOffered: {
              '@type': 'Service',
              name: 'Tử Vi Trọn Đời',
              description: 'Phân tích 12 Đại Vận trọn đời chi tiết',
            },
            price: 599000,
            priceCurrency: 'VND',
            availability: 'https://schema.org/InStock',
            validFrom: new Date().toISOString(),
          },
          {
            '@type': 'Offer',
            itemOffered: {
              '@type': 'Service',
              name: 'Luận Tổng Quát',
              description: 'Phân tích Đại Vận 10 năm tới',
            },
            price: 299000,
            priceCurrency: 'VND',
            availability: 'https://schema.org/InStock',
            validFrom: new Date().toISOString(),
          },
        ],
      },
    },
    {
      '@type': 'WebSite',
      '@id': 'https://trucnghi.vercel.app/#website',
      url: 'https://trucnghi.vercel.app',
      name: 'Tử Vi Trúc Nghi',
      description: 'Luận giải Tử Vi chuyên nghiệp - Biết vận hạn, nắm cơ hội, tránh rủi ro',
      publisher: {
        '@id': 'https://trucnghi.vercel.app/#organization',
      },
      potentialAction: {
        '@type': 'SearchAction',
        target: 'https://trucnghi.vercel.app/?q={search_term_string}',
        'query-input': 'required name=search_term_string',
      },
    },
  ],
};
---

<Layout metadata={metadata}>
  <!-- JSON-LD structured data -->
  <script type="application/ld+json" set:html={JSON.stringify(jsonLD)} />

  <!-- Critical CSS for above-the-fold content -->
  <style>
    /* Critical styles for hero section */
    .hero-gradient {
      background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #3730a3 100%);
    }

    /* Prevent layout shift */
    .aspect-ratio-16-9 {
      aspect-ratio: 16 / 9;
    }

    /* Smooth scroll behavior */
    html {
      scroll-behavior: smooth;
    }

    /* Loading state for React components */
    .react-loading {
      min-height: 400px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Account for fixed navbar */
    section {
      scroll-margin-top: 4rem;
    }
  </style>

  <!-- Navbar -->
  <Navbar />

  <!-- Hero Section -->
  <Hero />

  <!-- Trust Bar -->
  <TrustBar />

  <!-- About Section (Benefits) -->
  <section id="about">
    <BenefitsEnhanced />
  </section>

  <!-- Countdown Section -->
  <Countdown />

  <!-- Pricing Section -->
  <section id="pricing">
    <Pricing />
  </section>

  <!-- Testimonials Section -->
  <section id="testimonials">
    <Testimonials />
  </section>

  <!-- FAQ Section -->
  <section id="faq">
    <FAQ />
  </section>

  <!-- Call to Action Section -->
  <section class="py-12 sm:py-16 md:py-20 bg-gradient-to-br from-indigo-900 to-purple-900">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <ScrollReveal animation="fade-up">
        <h2 class="text-2xl sm:text-3xl md:text-4xl font-bold text-white mb-4 sm:mb-6 px-2">Sẵn sàng khám phá vận mệnh?</h2>
        <p class="text-base sm:text-lg md:text-xl text-indigo-200 mb-6 sm:mb-8 max-w-2xl mx-auto px-4">
          Chọn gói dịch vụ phù hợp với nhu cầu của bạn và bắt đầu hành trình tìm hiểu bản thân
        </p>
      </ScrollReveal>
      
      <ScrollReveal animation="scale-up" delay={200}>
        <a
          href="#pricing"
          class="inline-flex items-center justify-center bg-gradient-to-r from-yellow-400 to-orange-500 text-gray-900 font-bold py-3 px-6 sm:py-4 sm:px-8 rounded-xl text-base sm:text-lg hover:from-yellow-300 hover:to-orange-400 transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl w-full sm:w-auto"
          data-track="cta"
        >
          <svg class="w-5 h-5 sm:w-6 sm:h-6 mr-2 sm:mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
          </svg>
          Chọn Gói Dịch Vụ Ngay
        </a>
      </ScrollReveal>

      <div class="mt-6 sm:mt-8 grid grid-cols-1 md:grid-cols-3 gap-4 sm:gap-6 text-indigo-200">
        <ScrollReveal animation="fade-left" delay={300}>
          <div class="flex items-center justify-center">
            <svg class="w-6 h-6 sm:w-8 sm:h-8 text-green-400 mr-2 sm:mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
              <path
                fill-rule="evenodd"
                d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                clip-rule="evenodd"></path>
            </svg>
            <span class="text-sm sm:text-base">Thanh toán an toàn</span>
          </div>
        </ScrollReveal>
        <ScrollReveal animation="fade-up" delay={400}>
          <div class="flex items-center justify-center">
            <svg class="w-6 h-6 sm:w-8 sm:h-8 text-blue-400 mr-2 sm:mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
              <path
                fill-rule="evenodd"
                d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"
                clip-rule="evenodd"></path>
            </svg>
            <span class="text-sm sm:text-base">Nhận báo cáo trong 24h</span>
          </div>
        </ScrollReveal>
        <ScrollReveal animation="fade-right" delay={500}>
          <div class="flex items-center justify-center">
            <svg class="w-6 h-6 sm:w-8 sm:h-8 text-purple-400 mr-2 sm:mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
              <path
                fill-rule="evenodd"
                d="M18 8a6 6 0 01-7.743 5.743L10 14l-1 1-1 1H6v2H2v-4l4.257-4.257A6 6 0 1118 8zm-6-4a1 1 0 100 2 2 2 0 012 2 1 1 0 102 0 4 4 0 00-4-4z"
                clip-rule="evenodd"></path>
            </svg>
            <span class="text-sm sm:text-base">Bảo mật tuyệt đối</span>
          </div>
        </ScrollReveal>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <FooterContact />

  <!-- Performance optimizations -->
  <script>

    // Intersection Observer for lazy loading
    if ('IntersectionObserver' in window) {
      const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const img = entry.target;
            if (img.dataset.src) {
              img.src = img.dataset.src;
              img.classList.remove('lazy');
              observer.unobserve(img);
            }
          }
        });
      });

      document.querySelectorAll('img[data-src]').forEach((img) => {
        imageObserver.observe(img);
      });
    }

    // Performance monitoring
    if ('PerformanceObserver' in window) {
      const observer = new PerformanceObserver((list) => {
        for (const entry of list.getEntries()) {
          if (entry.entryType === 'largest-contentful-paint') {
            console.log('LCP:', entry.startTime);
          }
          if (entry.entryType === 'first-input' && 'processingStart' in entry) {
            console.log('FID:', (entry as any).processingStart - entry.startTime);
          }
        }
      });

      observer.observe({ entryTypes: ['largest-contentful-paint', 'first-input'] });
    }

    // Smooth scroll polyfill for older browsers
    if (!('scrollBehavior' in document.documentElement.style)) {
      // Dynamic import for smooth scroll polyfill
      const script = document.createElement('script');
      script.src = 'https://unpkg.com/smoothscroll-polyfill@0.4.4/dist/smoothscroll.min.js';
      script.onload = () => {
        if (typeof (window as any).smoothscroll !== 'undefined') {
          (window as any).smoothscroll.polyfill();
        }
      };
      document.head.appendChild(script);
    }

    // Analytics tracking (placeholder)
    function trackEvent(action: string, category: string, label: string) {
      // Declare gtag as a global function
      const gtag = (window as any).gtag;
      if (typeof gtag === 'function') {
        gtag('event', action, {
          event_category: category,
          event_label: label,
        });
      }
    }

    // Track scroll depth
    let maxScroll = 0;
    window.addEventListener('scroll', () => {
      const scrollPercent = Math.round((window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100);

      if (scrollPercent > maxScroll && scrollPercent % 25 === 0) {
        maxScroll = scrollPercent;
        trackEvent('scroll_depth', 'engagement', `${scrollPercent}%`);
      }
    });

    // Track CTA clicks
    document.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (target && target.closest && target.closest('[data-track="cta"]')) {
        const textContent = target.textContent || '';
        trackEvent('cta_click', 'conversion', textContent);
      }
    });
  </script>

  <!-- Critical resource hints -->
  <link rel="dns-prefetch" href="//fonts.googleapis.com" />
  <link rel="dns-prefetch" href="//www.google-analytics.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
</Layout>
